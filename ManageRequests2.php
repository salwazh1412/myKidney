<!DOCTYPE HTML>

 <?php require ('connection.php'); ?>
<html>
	<head>
        
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>myKidney</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Free HTML5 Website Template by gettemplates.co" />
	<meta name="keywords" content="free website templates, free html5, free template, free bootstrap, free website template, html5, css3, mobile first, responsive" />
	<meta name="author" content="gettemplates.co" />

  	<!-- Facebook and Twitter integration -->
	<meta property="og:title" content=""/>
	<meta property="og:image" content=""/>
	<meta property="og:url" content=""/>
	<meta property="og:site_name" content=""/>
	<meta property="og:description" content=""/>
	<meta name="twitter:title" content="" />
	<meta name="twitter:image" content="" />
	<meta name="twitter:url" content="" />
	<meta name="twitter:card" content="" />

	<!-- <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,300,600,400italic,700' rel='stylesheet' type='text/css'> -->
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="css/bootstrap.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">

	<!-- Owl Carousel  -->
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="css/style.css">

	<!-- Modernizr JS -->
	<script src="js/modernizr-2.6.2.min.js"></script>
	<!-- FOR IE9 below -->
	<!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->

         <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
                            $(function(){ //this is shorthand for document.ready
                            $('#match').on('click',function(){
        $('#inputUserAction').val($(this).data('userAction')); //update our hidden with the data
        $('#someFormId').submit(); //submit the form
        
                                
    });
});
         

</script>
	</head>
	<body>

	<div class="gtco-loader"></div>
	
	<div id="page">
	<nav class="gtco-nav" role="navigation">
		<div class="gtco-container">
			<div class="row">
				<div class="col-xs-2">
					<!-- <div id="gtco-logo"><a href="index.php">MyKidney</a></div> -->
                    <div id="gtco-logo"><a href="index.php"><img src="images/Logo.png" style="width:170px;"></a></div>
				</div>
				<div class="col-xs-8 text-center menu-1">
					<br>
                    <ul>
						<li class="active"><a href="AdminHome.php">Home</a></li>
				        <!-- <li><a href="">Search</a></li>
                        <li><a href="about.php">About</a></li>
						<li><a href="contact.php">Contact</a></li> -->
					</ul>
				</div>
				<div class="col-xs-2 text-right hidden-xs menu-2">
					
                    <ul>
                        <br><li class="btn-cta2"><a href="Login.php"><span> <div align="center">Logout</div>   </span></a></li>
					</ul>
					<ul>
                        <!-- <li class="btn-cta"><a href="#Signup"><span>Sign Up</span></a></li> -->
					</ul>
				</div>
			</div>
			
		</div>
	</nav>

	<header id="gtco-header" class="gtco-cover" role="banner" style="background-image:url(images/img_bg_1.jpg); height:170px;">

	</header>
        
<style>
table, th, td {
    border: 1px solid gray;
    border-collapse: collapse;
}
th, td {
    padding: 5px;
}
th {
    text-align: center;
}
</style>
        
        
	<div id="gtco-features">
		<div class="gtco-container">
			<div class="row" Style="margin-top:-150px;">
                
				<div>
                    <div class="feature-center animate-box" data-animate-effect="fadeIn">
                           
                        
	<div id="gtco-services">
		<div class="gtco-container">
			
			<div class="row animate-box">
				<div class="col-md-8 col-md-offset-2 text-center gtco-heading">
					<h2>Manage Requests</h2>
				<!--	<p>Select user to delete</p> -->
				</div>
			</div>
 <!-- 
			<div class="row animate-box">
				
				<div class="gtco-tabs">
					<ul class="gtco-tab-nav">
						<li class="active"><a href="#" data-tab="1"><span class="icon visible-xs"><i class="icon-command"></i></span>
                            <span class="hidden-xs">Web Design</span></a></li>
						<li><a href="#" data-tab="2"><span class="icon visible-xs"><i class="icon-bar-graph"></i></span>
                            <span class="hidden-xs">Online Marketing</span></a></li>
						<li><a href="#" data-tab="3">
                            <span class="icon visible-xs"><i class="icon-bag"></i></span><span class="hidden-xs">E-Commerce</span></a></li>
					</ul>

					
					<div class="gtco-tab-content-wrap">
						
                    
                        
                      <div class="gtco-tab-content tab-content active" data-tab-content="1">
							<div class="col-md-12">
								<h2>Web Design</h2>
								<p>Paragraph placeat quis fugiat provident veritatis quia iure a debitis adipisci dignissimos consectetur magni quas eius nobis reprehenderit soluta eligendi quo reiciendis fugit? Veritatis tenetur odio delectus quibusdam officiis est.</p>

								<p>Ullam dolorum iure dolore dicta fuga ipsa velit veritatis molestias totam fugiat soluta accusantium omnis quod similique placeat at. Dolorum ducimus libero fuga molestiae asperiores obcaecati corporis sint illo facilis.</p>

							</div>
						</div>
                        
                        
                     
                        
                        <div class="gtco-tab-content tab-content active" data-tab-content="2">
							<div class="col-md-12">
								<h2>Web Design</h2>
								<p>Paragraph placeat quis fugiat provident veritatis quia iure a debitis adipisci dignissimos consectetur magni quas eius nobis reprehenderit soluta eligendi quo reiciendis fugit? Veritatis tenetur odio delectus quibusdam officiis est.</p>

								<p>Ullam dolorum iure dolore dicta fuga ipsa velit veritatis molestias totam fugiat soluta accusantium omnis quod similique placeat at. Dolorum ducimus libero fuga molestiae asperiores obcaecati corporis sint illo facilis.</p>

							</div>
						</div>
                        
                          
                        
                        <div class="gtco-tab-content tab-content active" data-tab-content="3">
							<div class="col-md-12">
								<h2>Web Design</h2>
								<p>Paragraph placeat quis fugiat provident veritatis quia iure a debitis adipisci dignissimos consectetur magni quas eius nobis reprehenderit soluta eligendi quo reiciendis fugit? Veritatis tenetur odio delectus quibusdam officiis est.</p>

								<p>Ullam dolorum iure dolore dicta fuga ipsa velit veritatis molestias totam fugiat soluta accusantium omnis quod similique placeat at. Dolorum ducimus libero fuga molestiae asperiores obcaecati corporis sint illo facilis.</p>

							</div>
						</div> 
					</div>

				</div>
			</div> -->
		</div>
	</div>
                        <?php   
                      
                      //  $stmt = $pdo->prepare('SELECT * FROM users WHERE email = ? AND status=?');
                      //  $stmt->execute([$email, $status]);
                     //   $user = $stmt->fetch();
                        $target='./Tests/';
                        echo "<table style='width:100%';>";
                        echo "<form method='post' action='ManageRequests.php' id='someFormId'>";
                        echo "<input type='hidden' name='userAction' id='inputUserAction' value='' /> ";
                        echo "<tr><th>Patient Name</th><th>Patient Tests</th><th>Donor Name</th><th>Donor Tests</th><th>Mach</th></tr>";  
                        try {
                            $stmt = $conn->prepare("SELECT patient.User_ID as patientID, patient.Name as PName, patient.Test as PTest, donor.User_ID as donorID, donor.Name as DName, donor.Test as DTest 
                                FROM requests 
                                INNER JOIN patient ON patient.User_ID=requests.Patients_ID
                                INNER JOIN donor ON donor.User_ID=requests.Donor_ID
                                where requests.Donor_Approval=1 ORDER BY requests.Request_Date;");
                            $stmt->execute();
                            $result = $stmt->setFetchMode(PDO::FETCH_ASSOC);                            
                                foreach ($stmt as $row){
                                    echo "<tr>"."<td>".$row['PName']."</td>".
                                        "<td>". "<a href=" .$target.basename($row['PTest']).">Download</a>"."</td>".
                                        "<td>".$row['DName']."</td>".
                                        "<td>". "<a href=" .$target.basename($row['DTest']).">Download</a>"."</td>".
                                        "<td>". 
                                        "<input type='button' 
                                        ID='match' 
                                        name='match'value='Match' 
                                        class='btn btn-default btn-block' data-user-action='".$row['patientID']."-".$row['donorID']."' 
                        Style='background: rgb(82,211,170);margin-left:-60px; width: 100px; color:#ffffff;  float: right;' /></td>".
                                        
                                        "</tr>"."\n"
                                        ."</form>";
                                }
                        }catch(PDOException $e) {
                         echo "Error: " . $e->getMessage();
                        }$conn=null;
                        echo "</table>";           
                     if (!empty($_POST['userAction'])) {
                              $string = $_POST['userAction'];
                        list($part1, $part2) = explode('-', $string);
                        $part3=(int)$part1;
                        $part4=(int)$part2;
                                               
$db = new PDO("mysql:host=localhost;dbname=mykideny4;charset=utf8mb4", 'root', '');

// works not with the following set to 0. You can comment this line as 1 is default
//$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, 1);
                         
      $sql = "INSERT INTO matches(Patient_ID,Donor_ID) VALUES (".$part3.",".$part4.")";
    $stmt = $db->prepare($sql);
   if ( ! $stmt->execute() ){ die ("Error while execute query, The Error is: ".mysql_error ()); }
                         
                         
   $sql = "Delete From requests where Patients_ID = ".$part3." AND Donor_ID=".$part4."";
    $stmt = $db->prepare($sql);
   if ( ! $stmt->execute() )  die ("Error while execute query, The Error is: ".mysql_error ()); 

      $db=null;                           

                        


    
                         
                         
   
                             
   /*                                                         

$sql = "
INSERT INTO matches(Patient_ID, Donor_ID)VALUES (".$part3.",".$part4.");
";

try {
    $stmt = $db->prepare($sql);
    $stmt->execute();
}
catch (PDOException $e)
{
    echo $e->getMessage();
    die();
}
$sql = "
DELETE FROM requests WHERE Patient_ID =".$part3." AND Donor_ID=".$part4.";
";

try {$conn->beginTransaction();
    $stmt = $db->prepare($sql);
    $stmt->execute();
   // $db->commit(); 
}
catch (PDOException $e)
{
    echo $e->getMessage();
    die();
}*/

                         
                         
                         
                         
                         
                         
                         
                         
                     
                         /*
         $sql = "INSERT INTO matches (Patient_ID, Donor_ID) VALUES (3,10)"; 
         $stmt = $conn->prepare($sql);

//$stmt->execute(array("55","18"));
         
      //  $stmt1 = $conn->prepare("insert into matches (Patient_ID, Donor_ID) VALUES ('3','4')");
      // $stmt2 = $conn->prepare("DELETE FROM requests WHERE Patient_ID ='".$part3."' AND Donor_ID='".$part4."'");
                           $stmt->execute(); //$stmt2->execute();                           
                        }catch(PDOException $e) {
                         echo "Error: " . $e->getMessage();
                        } */ }
                        ?> 
                    </div>
                </div>
            </div> <!-- end of row div -->
		</div>
	</div>


	<!------ Footer -------->		
<?php
       
include ('footer.html');
        
?>
